<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caro P2P - N·ªôi B·ªô</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.8);
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            height: 100vh;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .game-container {
            width: 90%;
            max-width: 500px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 1px solid white;
            text-align: center;
        }

        h1 { color: var(--primary); margin-bottom: 24px; font-size: 28px; }

        .connection-panel {
            background: rgba(0,0,0,0.03);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .id-label { font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        
        #my-id { font-family: monospace; font-size: 16px; font-weight: 700; color: var(--primary); cursor: pointer; }
        
        .connect-form { display: flex; gap: 8px; margin-top: 12px; }
        
        input {
            flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; outline: none;
        }

        button {
            padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;
        }

        .status-msg { margin-bottom: 16px; font-weight: 600; height: 24px; }

        .board {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 2px;
            margin: 0 auto 24px;
            width: 600px;
            height: 600px;
            background: #cbd5e1;
            border: 2px solid #cbd5e1;
            overflow: auto;
        }

        .cell {
            background: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }

        /* Responsive board container for 20x20 */
        .board-wrapper {
            max-width: 100%;
            overflow: auto;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            background: #f1f5f9;
            padding: 10px;
        }

        .cell:hover:not(.occupied) {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .cell.x { color: var(--primary); }
        .cell.o { color: var(--danger); }
        .cell.occupied { cursor: not-allowed; }

        .player-info { display: flex; justify-content: space-around; margin-bottom: 20px; font-weight: 700; }
        .player-x { color: var(--primary); }
        .player-o { color: var(--danger); }

        .btn-reset { background: #64748b; margin-top: 10px; display: none; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>Caro P2P 9 √î</h1>

        <div class="connection-panel">
            <div class="id-label">ID c·ªßa b·∫°n (Click ƒë·ªÉ Copy)</div>
            <div id="my-id">ƒêang k·∫øt n·ªëi...</div>
            
            <div class="connect-form">
                <input type="text" id="target-id" placeholder="Nh·∫≠p ID ƒë·ªëi th·ªß...">
                <button id="connect-btn">K·∫øt n·ªëi</button>
            </div>
        </div>

        <div id="game-ui" class="hidden">
            <div class="player-info">
                <div class="player-x">B·∫†N: <span id="my-symbol">-</span></div>
                <div class="player-o">ƒê·ªêI TH·ª¶: <span id="opp-symbol">-</span></div>
            </div>

            <div id="status" class="status-msg">Ch·ªù ƒë·ªëi th·ªß...</div>

            <div class="board-wrapper">
                <div class="board" id="board">
                    <!-- JS will generate 400 cells here -->
                </div>
            </div>

            <button id="reset-btn" class="btn-reset">Ch∆°i l·∫°i</button>
        </div>
    </div>

    <script>
        const myIdDisplay = document.getElementById('my-id');
        const targetIdInput = document.getElementById('target-id');
        const connectBtn = document.getElementById('connect-btn');
        const gameUI = document.getElementById('game-ui');
        const boardElem = document.getElementById('board');
        const statusElem = document.getElementById('status');
        const resetBtn = document.getElementById('reset-btn');

        let peer = null;
        let conn = null;
        let mySymbol = ''; // 'X' ho·∫∑c 'O'
        const GRID_SIZE = 20;
        let board = Array(GRID_SIZE * GRID_SIZE).fill(null);
        let myTurn = false;
        let gameActive = false;

        // T·∫°o b√†n c·ªù 20x20
        function createBoard() {
            boardElem.innerHTML = '';
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.setAttribute('data-index', i);
                cell.onclick = () => {
                    if (gameActive && myTurn && !board[i]) {
                        makeMove(i, mySymbol, true);
                    }
                };
                boardElem.appendChild(cell);
            }
        }
        createBoard();

        const cells = () => document.querySelectorAll('.cell');

        // Kh·ªüi t·∫°o Peer
        const randomId = 'caro-' + Math.floor(Math.random() * 10000);
        peer = new Peer(randomId);

        peer.on('open', (id) => {
            myIdDisplay.innerText = id;
        });

        // L·∫Øng nghe k·∫øt n·ªëi ƒë·∫øn
        peer.on('connection', (incomingConn) => {
            if (conn) return; // Ch·ªâ ch∆°i 2 ng∆∞·ªùi
            conn = incomingConn;
            mySymbol = 'O'; // Ng∆∞·ªùi ƒë∆∞·ª£c g·ªçi l√† O
            setupConnection();
            initGame();
        });

        connectBtn.onclick = () => {
            const id = targetIdInput.value.trim();
            if (id) {
                conn = peer.connect(id);
                mySymbol = 'X'; // Ng∆∞·ªùi ch·ªß ƒë·ªông g·ªçi l√† X
                setupConnection();
                initGame();
            }
        };

        function setupConnection() {
            conn.on('open', () => {
                gameUI.classList.remove('hidden');
                document.querySelector('.connection-panel').classList.add('hidden');
                document.getElementById('my-symbol').innerText = mySymbol;
                document.getElementById('opp-symbol').innerText = mySymbol === 'X' ? 'O' : 'X';
                
                myTurn = (mySymbol === 'X');
                updateStatus();
                gameActive = true;
            });

            conn.on('data', (data) => {
                if (data.type === 'move') {
                    makeMove(data.index, data.symbol, false);
                } else if (data.type === 'reset') {
                    resetBoardLocal();
                }
            });

            conn.on('close', () => {
                alert('ƒê·ªëi th·ªß ƒë√£ tho√°t!');
                location.reload();
            });
        }

        function initGame() {
            cells.forEach(cell => {
                cell.onclick = () => {
                    const index = cell.getAttribute('data-index');
                    if (gameActive && myTurn && !board[index]) {
                        makeMove(index, mySymbol, true);
                    }
                };
            });
        }

        function makeMove(index, symbol, isLocal) {
            board[index] = symbol;
            const cell = document.querySelector(`.cell[data-index="${index}"]`);
            cell.innerText = symbol;
            cell.classList.add('occupied', symbol.toLowerCase());
            
            if (isLocal) {
                myTurn = false;
                conn.send({ type: 'move', index, symbol });
            } else {
                myTurn = true;
            }

            checkWinner(index);
            if (gameActive) updateStatus();
        }

        function updateStatus() {
            if (myTurn) {
                statusElem.innerText = "L∆∞·ª£t c·ªßa b·∫°n";
                statusElem.style.color = varToHex('--success');
            } else {
                statusElem.innerText = "Ch·ªù ƒë·ªëi th·ªß...";
                statusElem.style.color = "#64748b";
            }
        }

        function checkWinner(lastIndex) {
            const r = Math.floor(lastIndex / GRID_SIZE);
            const c = lastIndex % GRID_SIZE;
            const symbol = board[lastIndex];

            const directions = [
                [0, 1],  // Ngang
                [1, 0],  // D·ªçc
                [1, 1],  // Ch√©o xu√¥i
                [1, -1]  // Ch√©o ng∆∞·ª£c
            ];

            for (const [dr, dc] of directions) {
                let count = 1;

                // Ki·ªÉm tra 2 ph√≠a
                for (const step of [1, -1]) {
                    let currR = r + dr * step;
                    let currC = c + dc * step;

                    while (
                        currR >= 0 && currR < GRID_SIZE &&
                        currC >= 0 && currC < GRID_SIZE &&
                        board[currR * GRID_SIZE + currC] === symbol
                    ) {
                        count++;
                        currR += dr * step;
                        currC += dc * step;
                    }
                }

                if (count >= 5) {
                    gameActive = false;
                    statusElem.innerText = symbol === mySymbol ? "B·∫†N TH·∫ÆNG! üéâ" : "B·∫†N THUA! üíÄ";
                    statusElem.style.color = symbol === mySymbol ? "#10b981" : "#ef4444";
                    resetBtn.style.display = 'inline-block';
                    return;
                }
            }

            if (!board.includes(null)) {
                gameActive = false;
                statusElem.innerText = "H√íA! ü§ù";
                resetBtn.style.display = 'inline-block';
            }
        }

        resetBtn.onclick = () => {
            conn.send({ type: 'reset' });
            resetBoardLocal();
        };

        function resetBoardLocal() {
            board = Array(GRID_SIZE * GRID_SIZE).fill(null);
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerText = '';
                cell.classList.remove('occupied', 'x', 'o');
            });
            gameActive = true;
            myTurn = (mySymbol === 'X');
            updateStatus();
            resetBtn.style.display = 'none';
        }

        myIdDisplay.onclick = () => {
            navigator.clipboard.writeText(myIdDisplay.innerText);
            alert('ƒê√£ copy ID!');
        };

        function varToHex(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }
    </script>
</body>
</html>
